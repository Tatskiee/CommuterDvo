<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#ffffff">
    <title>Jeepney Route Finder</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        #map {
            flex: 1;
            width: 100%;
            z-index: 1;
        }
        .search-container {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 500px;
            z-index: 1000;
        }
        .search-bar {
            display: flex;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: all 0.2s ease;
        }
        #search-input {
            flex: 1;
            padding: 14px 16px;
            border: none;
            font-size: 16px;
            outline: none;
            color: #333;
        }
        #search-input::placeholder {
            color: #999;
        }
        .search-button {
            padding: 14px 20px;
            background: #ff5c5c;
            color: white;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .search-button:hover {
            background: #e04e4e;
        }
        #sidebar {
            position: absolute;
            left: 0;
            top: 0;
            width: 320px;
            height: 100%;
            background: white;
            box-shadow: 2px 0 8px rgba(0,0,0,0.08);
            z-index: 1000;
            transform: translateX(0);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }
        #sidebar.hidden {
            transform: translateX(-320px);
        }
        #toggle-sidebar {
            position: absolute;
            left: 320px;
            top: 50%;
            transform: translateY(-50%);
            background: white;
            border-radius: 0 12px 12px 0;
            padding: 10px;
            box-shadow: 2px 0 8px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 1001;
        }
        #toggle-sidebar.hidden {
            left: 0;
            border-radius: 12px 0 0 12px;
        }
        #sidebar-search {
            padding: 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        #sidebar-search-input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.2s ease;
        }
        #sidebar-search-input:focus {
            border-color: #ff5c5c;
        }
        #filter-tabs {
            display: flex;
            padding: 8px 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        .filter-tab {
            flex: 1;
            text-align: center;
            padding: 8px;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 8px;
            margin: 0 4px;
        }
        .filter-tab:hover {
            background: #f0f0f0;
        }
        .filter-tab.active {
            color: white;
            background: #ff5c5c;
        }
        #results, #saved-routes-view {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }
        #saved-routes-view {
            display: none;
        }
        #saved-routes-view.active {
            display: block;
        }
        #results.hidden {
            display: none;
        }
        .result-card, .saved-route-card {
            background: white;
            padding: 12px;
            margin-bottom: 12px;
            border-radius: 12px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .result-card.active {
            border: 2px solid #ff5c5c;
        }
        .route-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .route-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }
        .toggle-arrow {
            width: 20px;
            height: 20px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .toggle-arrow.expanded {
            transform: rotate(180deg);
        }
        .route-details {
            display: none;
            margin-top: 8px;
        }
        .route-details.expanded {
            display: block;
        }
        .jeepney-img {
            width: 80px;
            height: auto;
            border-radius: 8px;
            margin-top: 8px;
        }
        .action-button {
            padding: 8px 16px;
            margin: 4px;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            background: #f0f0f0;
            color: #333;
            transition: all 0.2s ease;
        }
        .action-button:hover {
            background: #e5e5e5;
        }
        .delete-button {
            background: #ffe6e6;
            color: #ff5c5c;
        }
        .delete-button:hover {
            background: #ffd4d4;
        }
        #saved-routes-section {
            border-top: 1px solid #e5e5e5;
            padding: 16px;
            background: #f7f7f7;
        }
        #back-button {
            display: none;
            padding: 8px;
            background: none;
            border: none;
            cursor: pointer;
        }
        #back-button.active {
            display: block;
        }
        #location-button, #pin-button {
            position: absolute;
            bottom: 16px;
            right: 16px;
            background: white;
            padding: 12px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            z-index: 1000;
        }
        #pin-button {
            bottom: 70px;
        }
        #location-button.active, #pin-button.active {
            background: #ff5c5c;
        }
        #location-button.active svg path, #pin-button.active svg path {
            fill: white;
        }
    </style>
</head>
<body>
    <div id="sidebar">
        <div id="sidebar-search">
            <input type="text" id="sidebar-search-input" placeholder="Search routes...">
            <p id="route-distance" class="text-gray-600 text-sm mt-2 hidden"></p>
        </div>
        <div id="filter-tabs">
            <div class="filter-tab active" data-tab="routes">Routes</div>
            <div class="filter-tab" data-tab="history">History</div>
            <div class="filter-tab" data-tab="saved">Saved</div>
        </div>
        <div id="results"></div>
        <div id="saved-routes-view">
            <button id="back-button" onclick="showResults('routes')">
                <svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2"/>
                </svg>
            </button>
            <div id="saved-routes"></div>
        </div>
        <div id="saved-routes-section">
            <button class="action-button" onclick="showSavedRoutes()">Saved Routes</button>
        </div>
    </div>
    <button id="toggle-sidebar" onclick="toggleSidebar()">
        <svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2"/>
        </svg>
    </button>
    <div class="search-container">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="Where to? (e.g., Abreeza Mall)">
            <button class="search-button" onclick="searchRoutes()">Go</button>
        </div>
    </div>
    <div id="map"></div>
    <button id="location-button" onclick="toggleLocation()">
        <svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 8C9.79 8 8 9.79 8 12C8 14.21 9.79 16 12 16C14.21 16 16 14.21 16 12C16 9.79 14.21 8 12 8ZM20.94 11C20.48 6.83 17.17 3.52 13 3.06V2H11V3.06C6.83 3.52 3.52 6.83 3.06 11H2V13H3.06C3.52 17.17 6.83 20.48 11 20.94V22H13V20.94C17.17 20.48 20.48 17.17 20.94 13H22V11H20.94ZM12 19C8.13 19 5 15.87 5 12C5 8.13 8.13 5 12 5C15.87 5 19 8.13 19 12C19 15.87 15.87 19 12 19Z" fill="#333"/>
        </svg>
    </button>
    <button id="pin-button" onclick="togglePinMode()">
        <svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M12 2C8.13 2 5 5.13 5 9C5 14.25 12 22 12 22C12 22 19 14.25 19 9C19 5.13 15.87 2 12 2ZM12 11.5C10.62 11.5 9.5 10.38 9.5 9C9.5 7.62 10.62 6.5 12 6.5C13.38 6.5 14.5 7.62 14.5 9C14.5 10.38 13.38 11.5 12 11.5Z" fill="#333"/>
        </svg>
    </button>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>
    <script>
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([7.0731, 125.6127], 13);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap'
        }).addTo(map);

        let userMarker = null;
        let watchId = null;
        let routeLayers = [];
        let walkingLayer = null;
        let pinMarker = null;
        let isPinMode = false;
        let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');
        let history = JSON.parse(localStorage.getItem('history') || '[]');
        let currentFilter = 'routes';
        let activeRouteIndex = null;
        let userLocation = null;
        let routeDataStore = [];

        function toggleLocation() {
            const button = document.getElementById('location-button');
            try {
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                    if (userMarker) {
                        map.removeLayer(userMarker);
                        userMarker = null;
                    }
                    if (walkingLayer) {
                        map.removeLayer(walkingLayer);
                        walkingLayer = null;
                    }
                    button.classList.remove('active');
                } else {
                    if (navigator.geolocation) {
                        watchId = navigator.geolocation.watchPosition(
                            position => {
                                const { latitude, longitude } = position.coords;
                                userLocation = [latitude, longitude];
                                if (userMarker) {
                                    userMarker.setLatLng(userLocation);
                                } else {
                                    userMarker = L.marker(userLocation, {
                                        icon: L.divIcon({
                                            className: 'user-location',
                                            html: '<div style="background-color: #ff5c5c; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                                            iconSize: [16, 16]
                                        })
                                    }).addTo(map);
                                }
                                map.panTo(userLocation);
                            },
                            error => {
                                document.getElementById('results').innerHTML = '<p class="text-red-500">Location access denied.</p>';
                                console.error('Geolocation error:', error);
                            },
                            { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                        );
                        button.classList.add('active');
                    } else {
                        document.getElementById('results').innerHTML = '<p class="text-red-500">Geolocation not supported.</p>';
                    }
                }
            } catch (error) {
                console.error('Error in toggleLocation:', error);
            }
        }

        function togglePinMode() {
            try {
                const button = document.getElementById('pin-button');
                isPinMode = !isPinMode;
                if (isPinMode) {
                    button.classList.add('active');
                    map.getContainer().style.cursor = 'crosshair';
                } else {
                    button.classList.remove('active');
                    map.getContainer().style.cursor = '';
                    if (pinMarker) {
                        map.removeLayer(pinMarker);
                        pinMarker = null;
                    }
                }
            } catch (error) {
                console.error('Error in togglePinMode:', error);
            }
        }

        function handleMapClick(e) {
            try {
                if (!isPinMode) return;
                const { lat, lng } = e.latlng;
                if (pinMarker) {
                    map.removeLayer(pinMarker);
                }
                pinMarker = L.marker([lat, lng], {
                    icon: L.divIcon({
                        className: 'pin-location',
                        html: '<div style="background-color: #4a90e2; width: 12px; height: 12px; border-radius: 50%; border: 2px solid white;"></div>',
                        iconSize: [16, 16]
                    })
                }).addTo(map);
                document.getElementById('search-input').value = `Pinned Location (${lat.toFixed(4)}, ${lng.toFixed(4)})`;
                searchRoutes([lat, lng]);
            } catch (error) {
                console.error('Error in handleMapClick:', error);
            }
        }

        map.on('click', handleMapClick);

        function toggleSidebar() {
            try {
                const sidebar = document.getElementById('sidebar');
                const toggleButton = document.getElementById('toggle-sidebar');
                if (sidebar.classList.contains('hidden')) {
                    sidebar.classList.remove('hidden');
                    toggleButton.classList.remove('hidden');
                    toggleButton.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M15 18L9 12L15 6" stroke="#333" stroke-width="2"/></svg>';
                } else {
                    sidebar.classList.add('hidden');
                    toggleButton.classList.add('hidden');
                    toggleButton.innerHTML = '<svg width="24" height="24" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M9 18L15 12L9 6" stroke="#333" stroke-width="2"/></svg>';
                }
            } catch (error) {
                console.error('Error in toggleSidebar:', error);
            }
        }

        function toggleDetails(element) {
            try {
                const details = element.parentElement.nextElementSibling;
                const arrow = element;
                if (details.classList.contains('expanded')) {
                    details.classList.remove('expanded');
                    arrow.classList.remove('expanded');
                } else {
                    details.classList.add('expanded');
                    arrow.classList.add('expanded');
                }
            } catch (error) {
                console.error('Error in toggleDetails:', error);
            }
        }

        const jeepneyRoutes = [
            {
                name: "Acacia-Buhangin",
                waypoints: [
                    [7.1158, 125.6167], [7.1135, 125.6178], [7.1032, 125.6234],
                    [7.0998, 125.6267], [7.0954, 125.6302], [7.1167, 125.6145]
                ],
                stops: ["Acacia", "Bajada", "Abreeza Mall", "Victoria Plaza", "GMall Bajada", "Buhangin"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Agdao-Bolton",
                waypoints: [
                    [7.0850, 125.6300], [7.0745, 125.6150], [7.0712, 125.6098], [7.0687, 125.6078]
                ],
                stops: ["Agdao", "R. Castillo", "San Pedro St", "Bolton Bridge"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Bangkal-SM Ecoland",
                waypoints: [
                    [7.0489, 125.5867], [7.0502, 125.5912], [7.0536, 125.5968],
                    [7.0687, 125.6078], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Bangkal", "Matina Crossing", "SM Ecoland", "Bolton Bridge", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Buhangin-Cabaguio",
                waypoints: [
                    [7.1167, 125.6145], [7.1032, 125.6234], [7.0850, 125.6300], [7.0940, 125.6400]
                ],
                stops: ["Buhangin", "Abreeza Mall", "Agdao", "Cabaguio"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Buhangin-Catalunan Grande",
                waypoints: [
                    [7.1167, 125.6145], [7.1135, 125.6178], [7.0536, 125.5968], [7.0400, 125.5800]
                ],
                stops: ["Buhangin", "Bajada", "SM Ecoland", "Catalunan Grande"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Buhangin-Claveria",
                waypoints: [
                    [7.1167, 125.6145], [7.1135, 125.6178], [7.0745, 125.6075], [7.0735, 125.6123]
                ],
                stops: ["Buhangin", "Bajada", "Quirino Ave", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Buhangin-Matina Aplaya",
                waypoints: [
                    [7.1167, 125.6145], [7.1135, 125.6178], [7.0536, 125.5968], [7.0450, 125.5900]
                ],
                stops: ["Buhangin", "Bajada", "SM Ecoland", "Matina Aplaya"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Buhangin-Toril",
                waypoints: [
                    [7.1167, 125.6145], [7.1135, 125.6178], [7.0536, 125.5968], [7.0200, 125.5000]
                ],
                stops: ["Buhangin", "Bajada", "SM Ecoland", "Toril"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Bunawan-Claveria",
                waypoints: [
                    [7.2300, 125.6800], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Bunawan", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Cabaguio-Claveria",
                waypoints: [
                    [7.0940, 125.6400], [7.0850, 125.6300], [7.0745, 125.6150], [7.0735, 125.6123]
                ],
                stops: ["Cabaguio", "Agdao", "R. Castillo", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Calinan-Claveria",
                waypoints: [
                    [7.1900, 125.5000], [7.1000, 125.5700], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Calinan", "Mintal", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Catalunan Grande-Claveria",
                waypoints: [
                    [7.0400, 125.5800], [7.0536, 125.5968], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Catalunan Grande", "SM Ecoland", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Dacudao-Claveria",
                waypoints: [
                    [7.1300, 125.6000], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Dacudao", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Ecoland-Claveria",
                waypoints: [
                    [7.0536, 125.5968], [7.0687, 125.6078], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["SM Ecoland", "Bolton Bridge", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Indangan-Claveria",
                waypoints: [
                    [7.1500, 125.5900], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Indangan", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Lanang-Claveria",
                waypoints: [
                    [7.1100, 125.6500], [7.1032, 125.6234], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Lanang", "Abreeza Mall", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Ma-a-Claveria",
                waypoints: [
                    [7.0800, 125.5800], [7.0536, 125.5968], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Ma-a", "SM Ecoland", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Matina Aplaya-Claveria",
                waypoints: [
                    [7.0450, 125.5900], [7.0536, 125.5968], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Matina Aplaya", "SM Ecoland", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Mintal-Claveria",
                waypoints: [
                    [7.1000, 125.5700], [7.0536, 125.5968], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Mintal", "SM Ecoland", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "NHA Buhangin-SM Ecoland",
                waypoints: [
                    [7.1214, 125.6112], [7.1167, 125.6145], [7.1135, 125.6178],
                    [7.0745, 125.6075], [7.0536, 125.5968]
                ],
                stops: ["NHA Buhangin", "Buhangin", "Bajada", "Quirino Ave", "SM Ecoland"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Panacan-Claveria",
                waypoints: [
                    [7.1600, 125.6600], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Panacan", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Sasa-Claveria",
                waypoints: [
                    [7.1300, 125.6500], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Sasa", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Tibungco-Claveria",
                waypoints: [
                    [7.2000, 125.6700], [7.1167, 125.6145], [7.1135, 125.6178], [7.0735, 125.6123]
                ],
                stops: ["Tibungco", "Buhangin", "Bajada", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            },
            {
                name: "Toril-Claveria",
                waypoints: [
                    [7.0200, 125.5000], [7.0536, 125.5968], [7.0712, 125.6098], [7.0735, 125.6123]
                ],
                stops: ["Toril", "SM Ecoland", "San Pedro St", "Claveria"],
                image: "https://images.unsplash.com/photo-1611832191399-2c8dbed3e6d0?ixlib=rb-4.0.3&auto=format&fit=crop&w=320&q=80"
            }
        ];

        // Map stops to coordinates for destination lookup
        const stopToCoord = {};
        jeepneyRoutes.forEach(route => {
            route.stops.forEach((stop, index) => {
                if (index < route.waypoints.length) {
                    stopToCoord[stop.toLowerCase()] = route.waypoints[index];
                }
            });
        });

        function haversineDistance(coord1, coord2) {
            try {
                const [lat1, lon1] = coord1;
                const [lat2, lon2] = coord2;
                const R = 6371; // Earth's radius in km
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                          Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                          Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c; // Distance in km
            } catch (error) {
                console.error('Error in haversineDistance:', error);
                return Infinity;
            }
        }

        function calculateRouteDistance(waypoints) {
            try {
                let total = 0;
                for (let i = 0; i < waypoints.length - 1; i++) {
                    total += haversineDistance(waypoints[i], waypoints[i + 1]);
                }
                return total;
            } catch (error) {
                console.error('Error in calculateRouteDistance:', error);
                return 0;
            }
        }

        function calculateFare(distance, isTwoRoute) {
            try {
                const baseFare = 12; // ₱12 for first 4 km
                const extraFare = 2; // ₱2 per additional km
                let fare = baseFare;
                if (distance > 4) {
                    fare += Math.ceil(distance - 4) * extraFare;
                }
                return isTwoRoute ? fare * 2 : fare; // Double for two-jeepney routes
            } catch (error) {
                console.error('Error in calculateFare:', error);
                return 0;
            }
        }

        function findNearestWaypoint(routes) {
            try {
                if (!userLocation) return null;
                let nearest = null;
                let minDistance = Infinity;
                routes.forEach(route => {
                    route.waypoints.forEach(waypoint => {
                        const distance = haversineDistance(userLocation, waypoint);
                        if (distance < minDistance) {
                            minDistance = distance;
                            nearest = waypoint;
                        }
                    });
                });
                return { waypoint: nearest, distance: minDistance };
            } catch (error) {
                console.error('Error in findNearestWaypoint:', error);
                return null;
            }
        }

        function drawWalkingPath(toWaypoint) {
            try {
                if (walkingLayer) {
                    map.removeLayer(walkingLayer);
                    walkingLayer = null;
                }
                if (userLocation && toWaypoint) {
                    walkingLayer = L.Routing.control({
                        waypoints: [
                            L.latLng(userLocation),
                            L.latLng(toWaypoint)
                        ],
                        lineOptions: {
                            styles: [{ color: '#555', weight: 4, opacity: 0.7, dashArray: '5, 10' }]
                        },
                        createMarker: () => null,
                        router: L.Routing.osrmv1({ 
                            serviceUrl: 'https://router.project-osrm.org/route/v1',
                            profile: 'foot'
                        }),
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false
                    }).on('routingerror', function(e) {
                        console.error('Routing error in drawWalkingPath:', e);
                    }).addTo(map);
                }
            } catch (error) {
                console.error('Error in drawWalkingPath:', error);
            }
        }

        function findNearestStop(coord) {
            try {
                let nearestStop = null;
                let minDistance = Infinity;
                for (const stop in stopToCoord) {
                    const distance = haversineDistance(coord, stopToCoord[stop]);
                    if (distance < minDistance) {
                        minDistance = distance;
                        nearestStop = stop;
                    }
                }
                return { stop: nearestStop, coord: stopToCoord[nearestStop], distance: minDistance };
            } catch (error) {
                console.error('Error in findNearestStop:', error);
                return null;
            }
        }

        function clearRoutes() {
            try {
                routeLayers.forEach(layer => {
                    if (map.hasLayer(layer)) {
                        map.removeLayer(layer);
                    }
                });
                routeLayers = [];
                document.querySelectorAll('.result-card').forEach(card => card.classList.remove('active'));
                const distanceEl = document.getElementById('route-distance');
                distanceEl.classList.add('hidden');
                distanceEl.textContent = '';
            } catch (error) {
                console.error('Error in clearRoutes:', error);
            }
        }

        function highlightRoute(index) {
            try {
                if (index < 0 || index >= routeDataStore.length) {
                    console.error('Invalid route index:', index);
                    return;
                }

                const routeData = routeDataStore[index];
                clearRoutes();

                const card = document.querySelector(`.result-card[data-index="${index}"]`);
                if (card) {
                    card.classList.add('active');
                }
                activeRouteIndex = index;

                const distanceEl = document.getElementById('route-distance');
                distanceEl.textContent = `Distance: ${routeData.totalDistance.toFixed(1)} km`;
                distanceEl.classList.remove('hidden');

                const validateWaypoints = waypoints => waypoints.every(coord => 
                    Array.isArray(coord) && coord.length === 2 && 
                    typeof coord[0] === 'number' && typeof coord[1] === 'number'
                );

                if (routeData.isTwoRoute) {
                    const { route1, route2 } = routeData;
                    if (!validateWaypoints(route1.waypoints) || !validateWaypoints(route2.waypoints)) {
                        console.error('Invalid waypoints for two-jeepney route');
                        L.polyline([...route1.waypoints, ...route2.waypoints], { color: '#ff5c5c', weight: 4, opacity: 0.7 }).addTo(map);
                        return;
                    }

                    const waypoints1 = route1.waypoints.map(coord => L.latLng(coord));
                    const routingControl1 = L.Routing.control({
                        waypoints: waypoints1,
                        lineOptions: { styles: [{ color: '#ff5c5c', weight: 4, opacity: 0.7 }] },
                        createMarker: () => null,
                        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false
                    }).on('routingerror', function(e) {
                        console.error('Routing error for route1:', e);
                        L.polyline(route1.waypoints, { color: '#ff5c5c', weight: 4, opacity: 0.7 }).addTo(map);
                    }).addTo(map);
                    routeLayers.push(routingControl1);

                    const waypoints2 = route2.waypoints.map(coord => L.latLng(coord));
                    const routingControl2 = L.Routing.control({
                        waypoints: waypoints2,
                        lineOptions: { styles: [{ color: '#f4b400', weight: 4, opacity: 0.7 }] },
                        createMarker: () => null,
                        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false
                    }).on('routingerror', function(e) {
                        console.error('Routing error for route2:', e);
                        L.polyline(route2.waypoints, { color: '#f4b400', weight: 4, opacity: 0.7 }).addTo(map);
                    }).addTo(map);
                    routeLayers.push(routingControl2);

                    map.fitBounds(getBounds([route1, route2]));
                } else {
                    const waypoints = routeData.route.waypoints;
                    if (!validateWaypoints(waypoints)) {
                        console.error('Invalid waypoints for single route');
                        L.polyline(waypoints, { color: '#ff5c5c', weight: 4, opacity: 0.7 }).addTo(map);
                        return;
                    }

                    const latLngs = waypoints.map(coord => L.latLng(coord));
                    const routingControl = L.Routing.control({
                        waypoints: latLngs,
                        lineOptions: { styles: [{ color: '#ff5c5c', weight: 4, opacity: 0.7 }] },
                        createMarker: () => null,
                        router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                        addWaypoints: false,
                        draggableWaypoints: false,
                        fitSelectedRoutes: false
                    }).on('routingerror', function(e) {
                        console.error('Routing error for single route:', e);
                        L.polyline(waypoints, { color: '#ff5c5c', weight: 4, opacity: 0.7 }).addTo(map);
                    }).addTo(map);
                    routeLayers.push(routingControl);
                    map.fitBounds(getBounds([routeData.route]));
                }
            } catch (error) {
                console.error('Error in highlightRoute:', error);
                document.getElementById('results').innerHTML = '<p class="text-red-500">Error displaying route.</p>';
            }
        }

        async function searchRoutes(pinnedCoord = null) {
            try {
                const destinationInput = pinnedCoord ? null : document.getElementById('search-input').value.trim().toLowerCase();
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = '';
                clearRoutes();
                if (walkingLayer) {
                    map.removeLayer(walkingLayer);
                    walkingLayer = null;
                }
                activeRouteIndex = null;
                routeDataStore = [];

                let destination = pinnedCoord ? 'Pinned Location' : destinationInput;
                if (!destination && !pinnedCoord) {
                    resultsDiv.innerHTML = '<p class="text-red-500">Please enter a destination or pin a location.</p>';
                    return;
                }

                let destCoord = pinnedCoord || stopToCoord[destination] || [7.0731, 125.6127];
                if (pinnedCoord) {
                    const nearestStop = findNearestStop(pinnedCoord);
                    if (nearestStop && nearestStop.distance < 0.5) { // Within 500m, use known stop
                        destination = nearestStop.stop;
                        destCoord = nearestStop.coord;
                    }
                }

                let foundRoutes = [];
                jeepneyRoutes.forEach(route => {
                    let destIndex = -1;
                    if (!pinnedCoord) {
                        destIndex = route.stops.findIndex(stop => stop.toLowerCase().includes(destination));
                    } else {
                        route.waypoints.forEach((waypoint, index) => {
                            if (haversineDistance(waypoint, destCoord) < 0.5) {
                                destIndex = index;
                            }
                        });
                    }
                    if (destIndex !== -1) {
                        const destWaypoint = route.waypoints[destIndex] || route.waypoints[route.waypoints.length - 1];
                        let totalDistance = calculateRouteDistance(route.waypoints.slice(0, destIndex + 1));
                        let walkingDistance = 0;
                        if (userLocation) {
                            const nearest = findNearestWaypoint([route]);
                            walkingDistance = nearest ? nearest.distance : 0;
                            totalDistance += walkingDistance;
                        }
                        const fare = calculateFare(totalDistance, false);
                        foundRoutes.push({ route, totalDistance, walkingDistance, fare, destWaypoint });
                    }
                });

                foundRoutes.sort((a, b) => a.totalDistance - b.totalDistance);
                foundRoutes = foundRoutes.slice(0, 3);

                if (foundRoutes.length === 0) {
                    resultsDiv.innerHTML = '<p class="text-red-500">No routes found.</p>';
                    return;
                }

                const nearest = findNearestWaypoint(foundRoutes.map(item => item.route));
                if (nearest && nearest.distance > 0.001) {
                    drawWalkingPath(nearest.waypoint);
                }

                let routeIndex = 0;
                for (const { route, fare, totalDistance } of foundRoutes) {
                    const index = routeIndex++;
                    const timestamp = new Date().toISOString();
                    routeDataStore.push({ route, isTwoRoute: false, destination, fare, totalDistance, timestamp });
                    resultsDiv.innerHTML += `
                        <div class="result-card" data-index="${index}">
                            <div class="route-header">
                                <span class="route-name">${route.name}</span>
                                <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="route-details">
                                <p class="text-sm text-gray-600">${new Date(timestamp).toLocaleString()}</p>
                                <p class="text-sm text-gray-600">To ${destination}, Fare: ₱${fare}, Distance: ${totalDistance.toFixed(1)} km</p>
                                <img src="${route.image}" alt="Jeepney" class="jeepney-img">
                                <div class="mt-2">
                                    <button class="action-button" onclick="highlightRoute(${index})">Select</button>
                                    <button class="action-button" onclick="saveRoute(${index})">Save</button>
                                    <button class="action-button" onclick="shareRoute(${index})">Share</button>
                                </div>
                            </div>
                        </div>`;

                    history.push({ type: 'single', route, destination, fare, totalDistance, timestamp });
                    localStorage.setItem('history', JSON.stringify(history));
                }

                let twoRouteCombinations = [];
                for (const route1 of jeepneyRoutes) {
                    for (const route2 of jeepneyRoutes) {
                        if (route1 !== route2) {
                            const commonStop = route1.stops.find(stop => route2.stops.includes(stop));
                            let destIndex = -1;
                            if (!pinnedCoord) {
                                destIndex = route2.stops.findIndex(stop => stop.toLowerCase().includes(destination));
                            } else {
                                route2.waypoints.forEach((waypoint, index) => {
                                    if (haversineDistance(waypoint, destCoord) < 0.5) {
                                        destIndex = index;
                                    }
                                });
                            }
                            if (commonStop && destIndex !== -1) {
                                const commonIndex1 = route1.stops.indexOf(commonStop);
                                const commonIndex2 = route2.stops.indexOf(commonStop);
                                const destWaypoint = route2.waypoints[destIndex] || route2.waypoints[route2.waypoints.length - 1];
                                let totalDistance = calculateRouteDistance(route1.waypoints.slice(0, commonIndex1 + 1)) +
                                                   calculateRouteDistance(route2.waypoints.slice(commonIndex2, destIndex + 1));
                                let walkingDistance = 0;
                                if (userLocation) {
                                    const nearest = findNearestWaypoint([route1]);
                                    walkingDistance = nearest ? nearest.distance : 0;
                                    totalDistance += walkingDistance;
                                }
                                const fare = calculateFare(totalDistance, true);
                                twoRouteCombinations.push({ route1, route2, commonStop, totalDistance, walkingDistance, fare, destWaypoint });
                            }
                        }
                    }
                }

                twoRouteCombinations.sort((a, b) => a.totalDistance - b.totalDistance);
                twoRouteCombinations = twoRouteCombinations.slice(0, Math.max(0, 3 - foundRoutes.length));

                for (const { route1, route2, commonStop, fare, totalDistance } of twoRouteCombinations) {
                    const index = routeIndex++;
                    const timestamp = new Date().toISOString();
                    routeDataStore.push({ route1, route2, commonStop, destination, isTwoRoute: true, fare, totalDistance, timestamp });
                    resultsDiv.innerHTML += `
                        <div class="result-card" data-index="${index}">
                            <div class="route-header">
                                <span class="route-name">${route1.name} → ${route2.name}</span>
                                <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="route-details">
                                <p class="text-sm text-gray-600">${new Date(timestamp).toLocaleString()}</p>
                                <p class="text-sm text-gray-600">Transfer at ${commonStop}</p>
                                <p class="text-sm text-gray-600">To ${destination}, Fare: ₱${fare}, Distance: ${totalDistance.toFixed(1)} km</p>
                                <img src="${route1.image}" alt="Jeepney" class="jeepney-img">
                                <div class="mt-2">
                                    <button class="action-button" onclick="highlightRoute(${index})">Select</button>
                                    <button class="action-button" onclick="saveTwoRoute(${index})">Save</button>
                                    <button class="action-button" onclick="shareTwoRoute(${index})">Share</button>
                                </div>
                            </div>
                        </div>`;

                    history.push({ type: 'two', route1, route2, commonStop, destination, fare, totalDistance, timestamp });
                    localStorage.setItem('history', JSON.stringify(history));
                }

                if (resultsDiv.innerHTML === '') {
                    resultsDiv.innerHTML = '<p class="text-red-500">No routes found.</p>';
                }
                showResults('routes');
            } catch (error) {
                console.error('Error in searchRoutes:', error);
                document.getElementById('results').innerHTML = '<p class="text-red-500">Error searching routes.</p>';
            }
        }

        function getBounds(routes) {
            try {
                const bounds = L.latLngBounds();
                routes.forEach(route => {
                    route.waypoints.forEach(coord => bounds.extend(coord));
                });
                return bounds;
            } catch (error) {
                console.error('Error in getBounds:', error);
                return map.getBounds();
            }
        }

        function saveRoute(index) {
            try {
                const data = routeDataStore[index];
                savedRoutes.push({ type: 'single', route: data.route, destination: data.destination, fare: data.fare, totalDistance: data.totalDistance, timestamp: data.timestamp });
                localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
                alert('Route saved!');
                updateSavedRoutes();
            } catch (error) {
                console.error('Error in saveRoute:', error);
            }
        }

        function saveTwoRoute(index) {
            try {
                const data = routeDataStore[index];
                savedRoutes.push({ type: 'two', route1: data.route1, route2: data.route2, commonStop: data.commonStop, destination: data.destination, fare: data.fare, totalDistance: data.totalDistance, timestamp: data.timestamp });
                localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
                alert('Two-jeepney route saved!');
                updateSavedRoutes();
            } catch (error) {
                console.error('Error in saveTwoRoute:', error);
            }
        }

        function shareRoute(index) {
            try {
                const data = routeDataStore[index];
                const text = `Jeepney Route to ${data.destination}: Take ${data.route.name}, Fare: ₱${data.fare}, Distance: ${data.totalDistance.toFixed(1)} km`;
                if (navigator.share) {
                    navigator.share({ title: 'Jeepney Route', text });
                } else {
                    prompt('Copy this to share:', text);
                }
            } catch (error) {
                console.error('Error in shareRoute:', error);
            }
        }

        function shareTwoRoute(index) {
            try {
                const data = routeDataStore[index];
                const text = `Two-Jeepney Route to ${data.destination}: Take ${data.route1.name}, then transfer to ${data.route2.name} at ${data.commonStop}, Fare: ₱${data.fare}, Distance: ${data.totalDistance.toFixed(1)} km`;
                if (navigator.share) {
                    navigator.share({ title: 'Jeepney Route', text });
                } else {
                    prompt('Copy this to share:', text);
                }
            } catch (error) {
                console.error('Error in shareTwoRoute:', error);
            }
        }

        function showSavedRoutes() {
            try {
                const resultsDiv = document.getElementById('results');
                const savedRoutesView = document.getElementById('saved-routes-view');
                const backButton = document.getElementById('back-button');
                resultsDiv.classList.add('hidden');
                savedRoutesView.classList.add('active');
                backButton.classList.add('active');
                updateSavedRoutes();
                applyFilter('saved');
            } catch (error) {
                console.error('Error in showSavedRoutes:', error);
            }
        }

        function showResults(tab) {
            try {
                const resultsDiv = document.getElementById('results');
                const savedRoutesView = document.getElementById('saved-routes-view');
                const backButton = document.getElementById('back-button');
                resultsDiv.classList.remove('hidden');
                savedRoutesView.classList.remove('active');
                backButton.classList.remove('active');
                applyFilter(tab);
            } catch (error) {
                console.error('Error in showResults:', error);
            }
        }

        function updateSavedRoutes() {
            try {
                const savedRoutesList = document.getElementById('saved-routes');
                const searchQuery = document.getElementById('sidebar-search-input').value.trim().toLowerCase();
                savedRoutesList.innerHTML = '';
                let filteredRoutes = savedRoutes;
                if (searchQuery) {
                    filteredRoutes = savedRoutes.filter(saved => {
                        if (saved.type === 'single') {
                            return saved.route.name.toLowerCase().includes(searchQuery) ||
                                   saved.destination.toLowerCase().includes(searchQuery);
                        } else {
                            return saved.route1.name.toLowerCase().includes(searchQuery) ||
                                   saved.route2.name.toLowerCase().includes(searchQuery) ||
                                   saved.commonStop.toLowerCase().includes(searchQuery) ||
                                   saved.destination.toLowerCase().includes(searchQuery);
                        }
                    });
                }
                filteredRoutes.forEach((saved, index) => {
                    if (saved.type === 'single') {
                        savedRoutesList.innerHTML += `
                            <div class="saved-route-card">
                                <div class="route-header">
                                    <span class="route-name">${saved.route.name}</span>
                                    <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="route-details">
                                    <p class="text-sm text-gray-600">${new Date(saved.timestamp).toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">To ${saved.destination}, Fare: ₱${saved.fare}, Distance: ${saved.totalDistance.toFixed(1)} km</p>
                                    <img src="${saved.route.image}" alt="Jeepney" class="jeepney-img">
                                    <div class="mt-2">
                                        <button class="action-button" onclick="reselectRoute(${index}, 'single')">Select</button>
                                        <button class="action-button delete-button" onclick="deleteSavedRoute(${index})">Delete</button>
                                    </div>
                                </div>
                            </div>`;
                    } else {
                        savedRoutesList.innerHTML += `
                            <div class="saved-route-card">
                                <div class="route-header">
                                    <span class="route-name">${saved.route1.name} → ${saved.route2.name}</span>
                                    <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <div class="route-details">
                                    <p class="text-sm text-gray-600">${new Date(saved.timestamp).toLocaleString()}</p>
                                    <p class="text-sm text-gray-600">Transfer at ${saved.commonStop}</p>
                                    <p class="text-sm text-gray-600">To ${saved.destination}, Fare: ₱${saved.fare}, Distance: ${saved.totalDistance.toFixed(1)} km</p>
                                    <img src="${saved.route1.image}" alt="Jeepney" class="jeepney-img">
                                    <div class="mt-2">
                                        <button class="action-button" onclick="reselectRoute(${index}, 'two')">Select</button>
                                        <button class="action-button delete-button" onclick="deleteSavedRoute(${index})">Delete</button>
                                    </div>
                                </div>
                            </div>`;
                    }
                });
                if (savedRoutesList.innerHTML === '') {
                    savedRoutesList.innerHTML = '<p class="text-gray-600">No saved routes found.</p>';
                }
            } catch (error) {
                console.error('Error in updateSavedRoutes:', error);
            }
        }

        function deleteSavedRoute(index) {
            try {
                savedRoutes.splice(index, 1);
                localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));
                updateSavedRoutes();
            } catch (error) {
                console.error('Error in deleteSavedRoute:', error);
            }
        }

        function reselectRoute(index, type) {
            try {
                const saved = savedRoutes[index];
                routeDataStore = [];
                if (type === 'single') {
                    routeDataStore.push({ 
                        route: saved.route, 
                        isTwoRoute: false, 
                        destination: saved.destination, 
                        fare: saved.fare, 
                        totalDistance: saved.totalDistance,
                        timestamp: saved.timestamp
                    });
                    highlightRoute(0);
                } else {
                    routeDataStore.push({ 
                        route1: saved.route1, 
                        route2: saved.route2, 
                        commonStop: saved.commonStop, 
                        destination: saved.destination, 
                        isTwoRoute: true, 
                        fare: saved.fare, 
                        totalDistance: saved.totalDistance,
                        timestamp: saved.timestamp
                    });
                    highlightRoute(0);
                }
                showResults('routes');
            } catch (error) {
                console.error('Error in reselectRoute:', error);
            }
        }

        function filterRoutes() {
            try {
                const resultsDiv = document.getElementById('results');
                const searchQuery = document.getElementById('sidebar-search-input').value.trim().toLowerCase();
                
                if (currentFilter === 'history') {
                    resultsDiv.innerHTML = '';
                    let filteredHistory = history;
                    if (searchQuery) {
                        filteredHistory = history.filter(item => {
                            if (item.type === 'single') {
                                return item.route.name.toLowerCase().includes(searchQuery) ||
                                       item.destination.toLowerCase().includes(searchQuery);
                            } else {
                                return item.route1.name.toLowerCase().includes(searchQuery) ||
                                       item.route2.name.toLowerCase().includes(searchQuery) ||
                                       item.commonStop.toLowerCase().includes(searchQuery) ||
                                       item.destination.toLowerCase().includes(searchQuery);
                            }
                        });
                    }
                    filteredHistory.forEach((item, index) => {
                        if (item.type === 'single') {
                            resultsDiv.innerHTML += `
                                <div class="result-card">
                                    <div class="route-header">
                                        <span class="route-name">${item.route.name}</span>
                                        <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="route-details">
                                        <p class="text-sm text-gray-600">${new Date(item.timestamp).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">To ${item.destination}, Fare: ₱${item.fare}, Distance: ${item.totalDistance.toFixed(1)} km</p>
                                        <img src="${item.route.image}" alt="Jeepney" class="jeepney-img">
                                        <button class="action-button mt-2" onclick="reselectHistory(${index}, 'single')">Select</button>
                                    </div>
                                </div>`;
                        } else {
                            resultsDiv.innerHTML += `
                                <div class="result-card">
                                    <div class="route-header">
                                        <span class="route-name">${item.route1.name} → ${item.route2.name}</span>
                                        <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="route-details">
                                        <p class="text-sm text-gray-600">${new Date(item.timestamp).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">Transfer at ${item.commonStop}</p>
                                        <p class="text-sm text-gray-600">To ${item.destination}, Fare: ₱${item.fare}, Distance: ${item.totalDistance.toFixed(1)} km</p>
                                        <img src="${item.route1.image}" alt="Jeepney" class="jeepney-img">
                                        <button class="action-button mt-2" onclick="reselectHistory(${index}, 'two')">Select</button>
                                    </div>
                                </div>`;
                        }
                    });
                    if (resultsDiv.innerHTML === '') {
                        resultsDiv.innerHTML = '<p class="text-gray-600">No history found.</p>';
                    }
                } else if (currentFilter === 'routes') {
                    resultsDiv.innerHTML = '';
                    let filteredRoutes = routeDataStore;
                    if (searchQuery) {
                        filteredRoutes = routeDataStore.filter(item => {
                            if (!item.isTwoRoute) {
                                return item.route.name.toLowerCase().includes(searchQuery) ||
                                       item.destination.toLowerCase().includes(searchQuery);
                            } else {
                                return item.route1.name.toLowerCase().includes(searchQuery) ||
                                       item.route2.name.toLowerCase().includes(searchQuery) ||
                                       item.commonStop.toLowerCase().includes(searchQuery) ||
                                       item.destination.toLowerCase().includes(searchQuery);
                            }
                        });
                    }
                    filteredRoutes.forEach((item, index) => {
                        if (!item.isTwoRoute) {
                            resultsDiv.innerHTML += `
                                <div class="result-card" data-index="${index}">
                                    <div class="route-header">
                                        <span class="route-name">${item.route.name}</span>
                                        <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="route-details">
                                        <p class="text-sm text-gray-600">${new Date(item.timestamp).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">To ${item.destination}, Fare: ₱${item.fare}, Distance: ${item.totalDistance.toFixed(1)} km</p>
                                        <img src="${item.route.image}" alt="Jeepney" class="jeepney-img">
                                        <div class="mt-2">
                                            <button class="action-button" onclick="highlightRoute(${index})">Select</button>
                                            <button class="action-button" onclick="saveRoute(${index})">Save</button>
                                            <button class="action-button" onclick="shareRoute(${index})">Share</button>
                                        </div>
                                    </div>
                                </div>`;
                        } else {
                            resultsDiv.innerHTML += `
                                <div class="result-card" data-index="${index}">
                                    <div class="route-header">
                                        <span class="route-name">${item.route1.name} → ${item.route2.name}</span>
                                        <svg class="toggle-arrow" onclick="toggleDetails(this)" viewBox="0 0 24 25" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M7 10L12 15L17 10" stroke="#666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </div>
                                    <div class="route-details">
                                        <p class="text-sm text-gray-600">${new Date(item.timestamp).toLocaleString()}</p>
                                        <p class="text-sm text-gray-600">Transfer at ${item.commonStop}</p>
                                        <p class="text-sm text-gray-600">To ${item.destination}, Fare: ₱${item.fare}, Distance: ${item.totalDistance.toFixed(1)} km</p>
                                        <img src="${item.route1.image}" alt="Jeepney" class="jeepney-img">
                                        <div class="mt-2">
                                            <button class="action-button" onclick="highlightRoute(${index})">Select</button>
                                            <button class="action-button" onclick="saveTwoRoute(${index})">Save</button>
                                            <button class="action-button" onclick="shareTwoRoute(${index})">Share</button>
                                        </div>
                                    </div>
                                </div>`;
                        }
                    });
                    if (resultsDiv.innerHTML === '') {
                        resultsDiv.innerHTML = '<p class="text-gray-600">Search for a destination to see routes.</p>';
                    }
                }
            } catch (error) {
                console.error('Error in filterRoutes:', error);
            }
        }

        function reselectHistory(index, type) {
            try {
                const item = history[index];
                routeDataStore = [];
                if (type === 'single') {
                    routeDataStore.push({ 
                        route: item.route, 
                        isTwoRoute: false, 
                        destination: item.destination, 
                        fare: item.fare, 
                        totalDistance: item.totalDistance,
                        timestamp: item.timestamp
                    });
                    highlightRoute(0);
                } else {
                    routeDataStore.push({ 
                        route1: item.route1, 
                        route2: item.route2, 
                        commonStop: item.commonStop, 
                        destination: item.destination, 
                        isTwoRoute: true, 
                        fare: item.fare, 
                        totalDistance: item.totalDistance,
                        timestamp: item.timestamp
                    });
                    highlightRoute(0);
                }
                showResults('routes');
            } catch (error) {
                console.error('Error in reselectHistory:', error);
            }
        }

        function applyFilter(tab) {
            try {
                currentFilter = tab;
                const tabs = document.querySelectorAll('.filter-tab');
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelector(`.filter-tab[data-tab="${tab}"]`).classList.add('active');
                
                const resultsDiv = document.getElementById('results');
                const savedRoutesView = document.getElementById('saved-routes-view');
                const backButton = document.getElementById('back-button');
                
                if (tab === 'saved') {
                    resultsDiv.classList.add('hidden');
                    savedRoutesView.classList.add('active');
                    backButton.classList.add('active');
                    updateSavedRoutes();
                } else {
                    resultsDiv.classList.remove('hidden');
                    savedRoutesView.classList.remove('active');
                    backButton.classList.remove('active');
                    filterRoutes();
                }
            } catch (error) {
                console.error('Error in applyFilter:', error);
            }
        }

        // Initialize with empty results
        document.getElementById('results').innerHTML = '<p class="text-gray-600">Search for a destination or pin a location to see routes.</p>';

        try {
            document.getElementById('search-input').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    searchRoutes();
                }
            });

            document.getElementById('sidebar-search-input').addEventListener('input', function() {
                if (currentFilter === 'saved') {
                    updateSavedRoutes();
                } else {
                    filterRoutes();
                }
            });

            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.addEventListener('click', () => applyFilter(tab.dataset.tab));
            });
        } catch (error) {
            console.error('Error setting up event listeners:', error);
        }
    </script>
</body>
</html>